<!DOCTYPE html>
<html lang="en-gb">
<head>
    <meta charset="utf-8">
    <link crossorigin="anonymous" media="all"
        rel="stylesheet"
        href="https://www.cogitri.dev/css/frameworks.css" />
    <link crossorigin="anonymous" media="all"
        rel="stylesheet" href="https://www.cogitri.dev/css/github.css" />
    <meta name="viewport" content="width=device-width">

    <title>Setting up Pantalaimon for usage with Matrix clients and using panctl - Cogitri&#39;s blog</title>

    <link rel="icon" type="image/x-icon" class="js-site-favicon" href="https://www.cogitri.dev/images/favicon.ico">
    <meta name="theme-color" content="#1e2327">
    
</head>

<body class="env-production emoji-size-boost page-responsive page-profile">
  <div class="position-relative js-header-wrapper ">
    <span class="Progress progress-pjax-loader position-fixed width-full js-pjax-loader-bar">
        <span class="progress-pjax-loader-bar top-0 left-0" style="width: 0%;"></span>
    </span>
    <header class="Header js-details-container Details flex-wrap flex-lg-nowrap p-responsive" role="banner">
        <div class="Header-item d-none d-lg-flex">
            <a class="Header-link" href="https://www.cogitri.dev" aria-label="Homepage"
                data-ga-click="Header, go to dashboard, icon:logo">
                <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
                    width="32" aria-hidden="true">
                    <path fill-rule="evenodd"
                        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z" />
                </svg>
            </a>
        </div>
        <div
            class="Header-item Header-item--full flex-column flex-lg-row width-full flex-order-2 flex-lg-order-none mr-0 mr-lg-3 mt-3 mt-lg-0 Details-content--hidden">
            <div class="header-search flex-self-stretch flex-lg-self-auto mr-0 mr-lg-3 mb-3 mb-lg-0 scoped-search site-scoped-search js-site-search position-relative js-jump-to"
                role="combobox" aria-owns="jump-to-results" aria-label="Search or jump to" aria-haspopup="listbox"
                aria-expanded="false">
                <div class="position-relative">
                </div>
            </div>
        </div>
        <div class="Header-item Header-item--full flex-justify-center d-lg-none position-relative" style="margin-right: auto;">
            <a class="Header-link" href="https://www.cogitri.dev" aria-label="Homepage"
                data-ga-click="Header, go to dashboard, icon:logo">
                <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
                    width="32" aria-hidden="true">
                    <path fill-rule="evenodd"
                        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z" />
                </svg>
            </a>
        </div>
        <div class="Header-item position-relative mr-0 d-none d-lg-flex">
            <details class="details-overlay details-reset">
                <summary class="Header-link" aria-label="View profile and more"
                    data-ga-click="Header, show menu, icon:avatar">
                    
                    <img alt="" class="avatar" src="https://avatars1.githubusercontent.com/u/8766773?s=460&amp;v=4" height="20" width="20">
                    
                </summary>
            </details>
        </div>
    </header>
</div>

<div id="start-of-content" class="show-on-focus"></div>
<div id="js-flash-container">
</div>

  
<div class="application-main " data-commit-hovercards-enabled="">
    <div itemscope="" itemtype="http://schema.org/SoftwareSourceCode" class="">
        <main id="js-repo-pjax-container" data-pjax-container="">
            <div class="pagehead repohead instapaper_ignore readability-menu experiment-repo-nav pt-0 pt-lg-4 ">
                <div class="repohead-details-container clearfix container-lg p-responsive d-none d-lg-block">
                    <div class="mb-3 d-flex">
                        <h1 class="public css-truncate float-none flex-auto width-fit pl-0">
                            <a class="avatar mr-1" href="https://www.cogitri.dev/about/">
                            

                                <img
                                    src="https://avatars1.githubusercontent.com/u/8766773?s=460&amp;v=4" width="26" height="26">
                            
                            </a>
                            <span class="author"><a
                                    href="https://www.cogitri.dev">Rasmus Thomsen</a></span>
                            <span class="path-divider">/</span>
                            <strong itemprop="name" class="css-truncate-target" style="max-width: 410px"><a
                                    href="https://www.cogitri.dev/posts/10-pantalaimon-setup/">Setting up Pantalaimon for usage with Matrix clients and using panctl</a></strong>

                            <div class="d-block text-small text-gray">
                                Created <time-ago datetime="2020-11-01" class="no-wrap"
                                    title="Created at 2020/11/01">
                                    2020-11-01</time-ago>
                                <span class="file-info-divider"></span>
                                Modifyed <time-ago datetime="2020-11-01" class="no-wrap"
                                    title="Modifyed  at 2020/11/01">
                                    2020-11-01</time-ago>
                            </div>
                        </h1>
                    </div>
                </div>




            </div>
            <div class="container-lg clearfix new-discussion-timeline experiment-repo-nav  p-responsive">
                <div class="repository-content ">
                    <div class="Box mt-3 position-relative">
                        <div class="Box-header py-2 d-flex flex-column flex-shrink-0 flex-md-row flex-md-items-center">
                            <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                                889 Words
                                
                            </div>
                        </div>

                        <div id="readme" class="Box-body readme blob instapaper_body js-code-block-container">
                            <article class="markdown-body entry-content p-3 p-md-6" itemprop="text"><blockquote>
<p>Article by editor Leo <a href="mailto:thinkabit.ukim@gmail.com">thinkabit.ukim@gmail.com</a></p>
</blockquote>
<p><a href="https://github.com/matrix-org/pantalaimon">Pantalaimon</a> is a End-to-End Encryption (E2EE) aware proxy daemon that
connects to a <a href="https://matrix.org/">Matrix</a> server and handles sending and receiving messages.
It also handles verifying sessions, verifying or blacklisting devices, and
exporting/importing session keys.</p>
<p>Its main use-case is to provide clients that have not yet fully implemented
some of the most important Matrix&rsquo;s features, namely verifying devices and
End-to-End encryption, a good man-in-the-middle that does it transparently
for you.</p>
<p>Today we will set up a local <code>pantalaimon</code> daemon and log in with
<a href="https://wiki.gnome.org/Apps/Fractal">Fractal</a>, the GNOME client for Matrix. We will also learn how to use the
<code>panctl</code> program from Pantalaimon to verify the session we started with Fractal.</p>
<h2 id="installation">Installation</h2>
<p>The first step is installing Pantalaimon. It can be installed via <code>pip</code> as it
is a python program, but we will instead use our distro repositories, in this
case <a href="https://alpinelinux.org">Alpine Linux</a>.</p>
<pre><code class="language-prompt" data-lang="prompt"># apk add pantalaimon pantalaimon-ui 
</code></pre><p>We also need to install Fractal, instead of using the distro repositories lets
use the flatpak-ed version from <a href="https://flathub.org/apps/details/org.gnome.Fractal">FlatHub</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ flatpak install fractal
Looking for matches‚Ä¶
Found similar ref(s) for ‚Äòfractal‚Äô in remote ‚Äòflathub‚Äô (user).
Use this remote? [Y/n]:
Found ref ‚Äòapp/org.gnome.Fractal/x86_64/stable‚Äô in remote ‚Äòflathub‚Äô (user).
Use this ref? [Y/n]:
Required runtime for org.gnome.Fractal/x86_64/stable (runtime/org.gnome.Platform/x86_64/3.36) found in remote flathub
Do you want to install it? [Y/n]:

org.gnome.Fractal permissions:
    ipc                  network      pulseaudio      wayland     x11     dri
    dbus access [1]

    [1] org.freedesktop.Notifications, org.freedesktop.secrets


        ID                                  Branch          Op          Remote           Download
 1. [‚úì] org.gnome.Fractal.Locale            stable          i           flathub            4.8¬†kB / 233.8¬†kB
 2. [‚úì] org.gnome.Platform.Locale           3.36            i           flathub           17.7¬†kB / 323.1¬†MB
 3. [‚úì] org.gnome.Platform                  3.36            i           flathub          172.7¬†MB / 326.0¬†MB
 4. [‚úì] org.gnome.Fractal                   stable          i           flathub            3.5¬†MB / 3.6¬†MB

Installation complete.
</code></pre></div><h2 id="configuration">Configuration</h2>
<p>Now that we have Pantalaimon installed we need to create the configuration file,
the location is <code>${XDG_CONFIG_HOME:-$HOME/.config}/pantalaimon/pantalaimon.conf</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#66d9ef">[local-matrix]</span>
<span style="color:#a6e22e">Homeserver</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">https://matrix.org</span>
<span style="color:#a6e22e">ListenAddress</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">localhost</span>
<span style="color:#a6e22e">ListenPort</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">8010</span>
</code></pre></div><p>The <code>Homeserver</code> key holds what is the server you&rsquo;re connecting to.</p>
<p>The <code>ListenAddress</code> key decides the URL where the daemon will listen for
connections, in this case we are doing a local server so use localhost.</p>
<p>Finally <code>ListenPort</code> decides what port of the URL that pantalaimon is going to
listen in.</p>
<h2 id="running">Running</h2>
<p>Now we run the daemon and start our client, just invoke the <code>pantalaimon</code> binary
and start the flatpak via <code>flatpak run org.gnome.Fractal</code>.</p>
<h3 id="fractal">Fractal</h3>
<p>When Fractal asks us for our provider instead of using the <code>Homeserver</code>, which is
normally expected, we instead put the <code>ListenAddress</code> and <code>ListenPort</code> from
pantalaimon as shown below:</p>
<p><img src="/posts/10-provider.png" alt="Our Provider is Local"></p>
<h2 id="panctl">panctl</h2>
<p>We now need to verify the Pantalaimon session, in this case we need an already
verified device running that can perform verification, one can safely use the
Element Web on the Desktop or the Mobile application.</p>
<p>We will use the <code>panctl</code> binary, which interacts with the running <code>pantalaimon</code>
daemon and allows us to verify our session.</p>
<h3 id="getting-info-from-panctl">Getting info from panctl</h3>
<p>But first lets take a look at what information <code>panctl</code> can give to us. It is
very important as we need the the correct ID of the device.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ panctl
panctl&gt; list-servers
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">pantalaimon servers</span>:
 - <span style="color:#66d9ef">Name</span>: local-matrix
 - <span style="color:#66d9ef">Pan users</span>:
   - @maxice8:matrix.org BFXSMBOBLH
</code></pre></div><p>We have one server running, the <code>Name</code> key holds the value that is present in
our configuration, and the <code>Pan users</code> collection holds all the users that are
logged in, in this case we are logged in via fractal and our id is <code>BFXSMBOBLH</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">panctl&gt; list-devices @maxice8:matrix.org @maxice8:matrix.org
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">Devices for user @maxice8:matrix.org</span>:
 - <span style="color:#66d9ef">Display name</span>:  FluffyChat android
   - <span style="color:#66d9ef">Device id</span>:   UXOXMSYWMH
   - <span style="color:#66d9ef">Device key</span>:  [STRENG GEHEIM]
   - <span style="color:#66d9ef">Trust state</span>: Verified
 - <span style="color:#66d9ef">Display name</span>:  Element Desktop (Linux)
   - <span style="color:#66d9ef">Device id</span>:   QPOOTXJLUS
   - <span style="color:#66d9ef">Device key</span>:  [STRENG GEHEIM]
   - <span style="color:#66d9ef">Trust state</span>: Verified
</code></pre></div><p>Those are my devices, you can see I use <a href="https://fluffychat.im/">FlufflyChat</a> on my Android phone
and have Element Desktop on my desktop, we will use the latter to perform
the confirmation.</p>
<p>Important here is to take note of the ID of the device we want to start the
verification with, in this case the ID is <code>QPOOTXJLUS</code>.</p>
<h3 id="starting-verification-from-panctl">Starting verification from panctl</h3>
<p>First we call the start-verification program</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">panctl&gt; start-verification @maxice8:matrix.org @maxice8:matrix.org QPOOTXJLUS
Successfully started the key verification request
</code></pre></div><p>Then we look at our Element client:</p>
<p><img src="/posts/10-verification.png" alt="On Element Web"></p>
<p>Click <code>continue</code>, and then switch back to <code>panctl</code> we need to check if the
emojis match.</p>
<p><img src="/posts/10-match.png" alt="Do They Match?"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Short authentication string for pan user @maxice8:matrix.org from @maxice8:matrix.org via QPOOTXJLUS:
     üöÄ          üîë          üçé          üöÇ          üé∏          ‚öì          üîß
   Rocket       Key        Apple       Train       Guitar      Anchor      Wrench
</code></pre></div><p>If they match we can click <code>They match</code> in Element and on panctl we need to
confirm-verification:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">panctl&gt; confirm-verification @maxice8:matrix.org @maxice8:matrix.org QPOOTXJLUS
Device QPOOTXJLUS of user @maxice8:matrix.org succesfully verified for pan user @maxice8:matrix.org.
</code></pre></div><p>And in your Element client ?</p>
<p><img src="/posts/10-verified.png" alt="Success!"></p>
<p>Now, that doesn&rsquo;t mean we are done, we can also import/export the End-to-End
encryption keys to be used in other contexts.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">panctl&gt; export-keys @maxice8:matrix.org ~/tmp/ourkeys pass
Succesfully exported keys for @maxice8:matrix.org to /home/enty/tmp/ourkeys
panctl&gt; import-keys @maxice8:matrix.org ~/tmp/ourkeys pass
Succesfully imported keys for @maxice8:matrix.org from /home/enty/tmp/ourkeys
</code></pre></div></article>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>



  <div class="footer container-lg width-full p-responsive" role="contentinfo">
    <div
        class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
        <ul
            class="list-style-none d-flex flex-wrap col-12 col-lg-5 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
            <li class="mr-3 mr-lg-0">¬© 2019. Theme by <a href="https://github.com/MeiK2333/github-style"><span>github-style</span></a></li>
        </ul>

        <a aria-label="Homepage" title="Cogitri&#39;s blog" class="footer-octicon d-none d-lg-block mx-lg-4"
            href="https://www.cogitri.dev">
            <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24"
                aria-hidden="true">
                <path fill-rule="evenodd"
                    d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                </path>
            </svg>
        </a>
        <ul
            class="list-style-none d-flex flex-wrap col-12 col-lg-5 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
        </ul>
    </div>
    <div class="d-flex flex-justify-center pb-6">
        <span class="f6 text-gray-light"></span>
    </div>
</div>

<script crossorigin="anonymous"
    type="application/javascript" src="https://www.cogitri.dev/js/frameworks.js"></script>

<script crossorigin="anonymous" async="async"
    type="application/javascript" src="https://www.cogitri.dev/js/github-bootstrap.js"></script>
<script>
    let classs = ['pinned-item-desc', 'text-gray', 'text-small', 'd-block', 'mt-2', 'mb-3'];
    const pinned_posts = document.getElementsByName('pinned-post');
    for (let i = 0; i < pinned_posts.length; i++) {
        for (let j = 0; j < classs.length; j++) {
            const ps = pinned_posts[i].getElementsByTagName('p');
            for (let k = 0; k < ps.length; k++) {
                ps[k].classList.add(classs[j]);
            }
        }
    }
    classs = [ 'd-inline-block', 'text-gray', 'mb-2', 'pr-4'];
    const posts_posts = document.getElementsByName('posts-post');
    for (let i = 0; i < posts_posts.length; i++) {
        for (let j = 0; j < classs.length; j++) {
            const ps = posts_posts[i].getElementsByTagName('p');
            for (let k = 0; k < ps.length; k++) {
                ps[k].classList.add(classs[j]);
            }
        }
    }
</script>
</body>

</html>