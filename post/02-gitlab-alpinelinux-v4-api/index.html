<!doctype html>
<html class="no-js" lang="">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, maximum-scale=1">
    <title>Contributing to Alpine Linux: making Merge Requests - Cogitri&#39;s blog</title>

    
    <meta name="keywords" content="">
    <meta name="description" content="">
    
    <link rel="stylesheet" href="/css/highlight.min.css">
    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="/css/diello.css">
    <link rel="stylesheet" href="/css/main.css">
    
    
</head>


<body>
    <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
    <![endif]-->

  
    <div class="flex-column">
        <div class="ads">
    
</div>

        <div class="home">
            <div class="logo">
                <h1><a href="/">Cogitri&#39;s blog</a></h1>
            </div>
            <div class="navigation">
    
    <a href="/" class="">HOME</a>
    <a href="javascript:void(0);" class="current">ARTICLE</a>
    
</div>

            <div>
                <article>
                    <h3>Contributing to Alpine Linux: making Merge Requests</h3>
                    <div class="less">
                        <time>Published: Tuesday, Oct 29, 2019</time>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;5 minute read&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;Using 1034 words
                    </div>
                    <div class="em"><h1 id="introduction">Introduction</h1>
<blockquote>
<p>Guest article by maxice8</p>
</blockquote>
<p>Some time ago, <a href="https://alpinelinux.org">Alpine Linux</a> started using their self-hosted
<a href="https://gitlab.alpinelinux.org">GitLab instance</a> to accept contributions via merge requests.</p>
<p>I wanted to move to it immediately as using their GitLab instance is planned to be the main repo (it
is currently a mirror to git.alpinelinux.org).</p>
<h1 id="how-it-was-before">How it was before</h1>
<p>Before using their GitLab instance I used their <a href="https://github.com/alpinelinux/aports">GitHub repo</a> to
contribute, I would use the amazing <a href="https://github.com/github/hub">hub</a> tool, which after login with my
personal access token would allow me to easily check out pull requests and merge them from the CLI.</p>
<p>The scripts for it are very simple, most of the logic is on hub and a few lines of shell just wrap around
it for my most common use cases.</p>
<p>This one uses hub to checkout a PR someone has made:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>set -eu
<span style="color:#66d9ef">while</span> <span style="color:#f92672">[</span> $# -gt <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>
<span style="color:#66d9ef">do</span>
	<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $# -gt <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>
	<span style="color:#66d9ef">then</span>
		args<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74"> </span>$2<span style="color:#e6db74">&#34;</span>
		shift <span style="color:#ae81ff">2</span>
	<span style="color:#66d9ef">else</span>
		args<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>
		shift <span style="color:#ae81ff">1</span>
	<span style="color:#66d9ef">fi</span>
	hub pr checkout $args
	pullp
<span style="color:#66d9ef">done</span>
</code></pre></div><h1 id="moving-to-gitlab">Moving to GitLab</h1>
<p>GitLab doesn&rsquo;t have a tool like hub that makes it super easy to interact with the GitLab V4 API like
hub does with the GitHub API. So I turned into accessing the API by myself with the ever trustworthy curl.</p>
<h2 id="finding-the-endpoint">Finding the endpoint</h2>
<p>Since GitLab allows self hosting, the first thing you have to do is find our respective GitLab endpoint. GitHub
is a centralized proprietary service so it doesn&rsquo;t have this issue.</p>
<p>This is the following code present in all my scripts that deal with GitLab (I believe the comments
are enough to tell what they are for and what they meant).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># Try to detect host, strip the .git suffix</span>
<span style="color:#75715e"># This is where the domain is, most normally gitlab.com</span>
<span style="color:#75715e"># but also works with other custom domains.</span>
HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>git config remote.upstream.url | cut -d / -f -3<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># This is the ENDPOINT of the project you forked, if we call this with</span>
<span style="color:#75715e"># curl we get a JSON payload that describes the repo, including stuff like</span>
<span style="color:#75715e"># its :id and :name</span>
ENDPOINT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$HOST<span style="color:#e6db74">&#34;</span>/api/v4/projects/<span style="color:#e6db74">&#34;</span>$origin_owner<span style="color:#e6db74">&#34;</span>%2F<span style="color:#e6db74">&#34;</span>$origin_repo<span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># This is the ENDPOINT of the project itself, we need to get its :id value to</span>
<span style="color:#75715e"># pass as the &#39;target_project_id&#39;</span>
UPSTREAM_ENDPOINT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$HOST<span style="color:#e6db74">&#34;</span>/api/v4/projects/<span style="color:#e6db74">&#34;</span>$upstream_owner<span style="color:#e6db74">&#34;</span>%2F<span style="color:#e6db74">&#34;</span>$upstream_repo<span style="color:#e6db74">&#34;</span>
</code></pre></div><h2 id="finding-the-project-id">Finding the project id</h2>
<p>Each project has its own id, which we need to pass in the request to the GitLab API so it
knows which repo we target when creating the merge request.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">_get_project_id<span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
	repo<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>			| sed -e <span style="color:#e6db74">&#39;s|https://||g&#39;</span> -e <span style="color:#e6db74">&#39;s|%2F|.|&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>			| tr <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#e6db74">&#39;.&#39;</span> <span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>

	<span style="color:#75715e"># Create cache directory if it doesn&#39;t exist</span>
	<span style="color:#f92672">[</span> -d <span style="color:#e6db74">&#34;</span>$XDG_CACHE_HOME<span style="color:#e6db74">&#34;</span>/mkmr <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> mkdir -p <span style="color:#e6db74">&#34;</span>$XDG_CACHE_HOME<span style="color:#e6db74">&#34;</span>/mkmr

	<span style="color:#75715e"># The project ID is cached, read it out</span>
	<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -f <span style="color:#e6db74">&#34;</span>$XDG_CACHE_HOME<span style="color:#e6db74">&#34;</span>/mkmr/<span style="color:#e6db74">&#34;</span>$repo<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
		cat <span style="color:#e6db74">&#34;</span>$XDG_CACHE_HOME<span style="color:#e6db74">&#34;</span>/mkmr/<span style="color:#e6db74">&#34;</span>$repo<span style="color:#e6db74">&#34;</span>
		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
	<span style="color:#66d9ef">fi</span>

	<span style="color:#75715e"># Call the GitLab API to see the id of the repo and write it to the cache</span>
	curl --silent <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> | jq <span style="color:#e6db74">&#39;.id // empty&#39;</span> | tee <span style="color:#e6db74">&#34;</span>$XDG_CACHE_HOME<span style="color:#e6db74">&#34;</span>/mkmr/<span style="color:#e6db74">&#34;</span>$repo<span style="color:#e6db74">&#34;</span>

	<span style="color:#f92672">[</span> -s <span style="color:#e6db74">&#34;</span>$XDG_CACHE_HOME<span style="color:#e6db74">&#34;</span>/mkmr/<span style="color:#e6db74">&#34;</span>$repo<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>The code above finds the project id via a request to the GitLab API which can be slow
so we cache the id of the project so you don&rsquo;t need to call it every time you have to
make a merge request.</p>
<h2 id="crafting-the-json-payload">Crafting the JSON payload</h2>
<p>The GitLab API takes a JSON payload for its requests, so we need to craft one in shell
for it, which is easier than initially thought.</p>
<p>This is the first part of the payload, and will always appear, regardless of whatever
options the user has passed to the script when creating the merge requests</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">	<span style="color:#75715e"># JSON payload that will be used to create the branch</span>
	BODY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{
</span><span style="color:#e6db74">		\&#34;id\&#34;: \&#34;</span><span style="color:#e6db74">${</span>origin_owner<span style="color:#e6db74">}</span><span style="color:#e6db74">%2F</span><span style="color:#e6db74">${</span>origin_repo<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;,
</span><span style="color:#e6db74">		\&#34;source_branch\&#34;: \&#34;</span><span style="color:#66d9ef">$(</span>git rev-parse --abbrev-ref HEAD<span style="color:#66d9ef">)</span><span style="color:#e6db74">\&#34;,
</span><span style="color:#e6db74">		\&#34;remove_source_branch\&#34;: true,</span><span style="color:#e6db74">&#34;</span>
</code></pre></div><p>The second part adds labels to the merge request if the user passed them via the &ndash;labels
option. It also sets the description of the merge request, which the user can set by passing
&ndash;description and/or passing &ndash;edit (edit with $EDITOR).</p>
<blockquote>
<p>the A-upgrade label is automatically added if it detects an Alpine Linux upgrade commit
<!-- raw HTML omitted -->/<!-- raw HTML omitted -->: upgrade to <!-- raw HTML omitted --></p>
<p>The A-add label is automatically added if it detects an Alpine Linux add commit
<!-- raw HTML omitted -->/<!-- raw HTML omitted -->: new aport</p>
<p>The A-move label is automatically added if it detects an Alpine Linux move commit
<!-- raw HTML omitted -->/<!-- raw HTML omitted -->: move from <!-- raw HTML omitted --></p>
</blockquote>
<p>Note that we use awk to convert all newlines to literal \n, this is required and GitLab will
translate them back from literal \n to newlines.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">	<span style="color:#75715e"># If we set labels then append it to body</span>
	<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -n <span style="color:#e6db74">&#34;</span>$LABEL<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
		BODY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$BODY<span style="color:#e6db74">
</span><span style="color:#e6db74">		\&#34;labels\&#34;: \&#34;</span>$LABEL<span style="color:#e6db74">\&#34;,</span><span style="color:#e6db74">&#34;</span>
	<span style="color:#66d9ef">fi</span>

	<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -n <span style="color:#e6db74">&#34;</span>$DESCRIPTION<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
		BODY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$BODY<span style="color:#e6db74">
</span><span style="color:#e6db74">		\&#34;description\&#34;: \&#34;</span><span style="color:#66d9ef">$(</span>printf <span style="color:#e6db74">&#34;%s&#34;</span> <span style="color:#e6db74">&#34;</span>$DESCRIPTION<span style="color:#e6db74">&#34;</span> | awk <span style="color:#e6db74">&#39;{printf  &#34;%s\\n&#34;, $0}&#39;</span> <span style="color:#66d9ef">)</span><span style="color:#e6db74">\&#34;,</span><span style="color:#e6db74">&#34;</span>
	<span style="color:#66d9ef">fi</span>
</code></pre></div><p>The last part sets the target_branch, which is where you want to merge the merge request into,
most of the time it is the master branch, but in some cases you might want to merge into other
branches with &ndash;target-branch.</p>
<blockquote>
<p>There is also logic specific to Alpine Linux for setting the target_branch to one of its
stable branches for backporting</p>
</blockquote>
<p>If the branch only contains one commit deviating from the target branch it sets the title and description of the merge request to the commit&rsquo;s text. If there are multiple deviating commits it allows the user to pick one of the commits to use its text. Users can also pass the <code>--title</code>  option to the script to write their own title</p>
<p>The assignee_id is rarely used since it is very annoying to use but if you pass it with &ndash;assignees then
the user that matches the id will be marked as assignee on the merge request.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">	BODY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$BODY<span style="color:#e6db74">
</span><span style="color:#e6db74">		\&#34;target_branch\&#34;: \&#34;</span>$TARGET_BRANCH<span style="color:#e6db74">\&#34;,
</span><span style="color:#e6db74">		\&#34;title\&#34;: \&#34;</span>$TITLE<span style="color:#e6db74">\&#34;,
</span><span style="color:#e6db74">		\&#34;assignee_id\&#34;: \&#34;</span>$ASSIGN<span style="color:#e6db74">\&#34;,
</span><span style="color:#e6db74">		\&#34;target_project_id\&#34;: </span>$PROJECT_ID<span style="color:#e6db74">
</span><span style="color:#e6db74">	}</span><span style="color:#e6db74">&#34;</span>;
</code></pre></div><h2 id="calling-the-api">Calling the API</h2>
<p>After the JSON payload is done we now call the API with curl.</p>
<p>For it we have to provide our own personal access token. To do it we use the
freedesktop <a href="https://freedesktop.org/wiki/Specifications/secret-storage-spec/secrets-api-0.1.html">Secrets API</a>
and <a href="https://manpages.ubuntu.com/manpages/bionic/man1/secret-tool.1.html">secret-tool(1)</a> to
query the system keyring for the private token. Users can just put the value for
their own personal access token.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">	JSON<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>curl -X POST <span style="color:#e6db74">&#34;</span>$ENDPOINT<span style="color:#e6db74">&#34;</span>/merge_requests <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>			--header <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">PRIVATE-TOKEN: </span><span style="color:#66d9ef">$(</span>secret-tool lookup Path a.o/gitlab/token/mkmr<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>			--header <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>			--data <span style="color:#e6db74">&#34;</span>$BODY<span style="color:#e6db74">&#34;</span> --silent<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>

	WEB_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$JSON<span style="color:#e6db74">&#34;</span> | jq <span style="color:#e6db74">&#39;.web_url // empty&#39;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>

	<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z <span style="color:#e6db74">&#34;</span>$WEB_URL<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
		echo <span style="color:#e6db74">&#34;</span>$JSON<span style="color:#e6db74">&#34;</span> | jq -r .
	<span style="color:#66d9ef">else</span>
		echo <span style="color:#e6db74">&#34;</span>$WEB_URL<span style="color:#e6db74">&#34;</span> | tr -d <span style="color:#e6db74">&#39;&#34;&#39;</span>
	<span style="color:#66d9ef">fi</span>
</code></pre></div></div>
                    <br />
                    <br />
                    <div class="less">Page link: <a href="/post/02-gitlab-alpinelinux-v4-api/" class="pagelink">/post/02-gitlab-alpinelinux-v4-api/</a></div>
                    <div class="line-dotted"></div>
                <article>
            </div>
            <footer>
    <div>
    
          	 
    
    </div>
</footer>

        </div>
        <div class="ads">
    
</div>

    </div>


  <script src="/js/vendor/modernizr-3.6.0.min.js"></script>
<script src="/js/vendor/jquery-3.3.1.min.js"></script>
<script>window.jQuery || document.write('<script src="\/js/vendor/jquery-3.3.1.min.js"><\/script>')</script>
<script src="/js/plugins.js"></script>
<script src="/js/main.js"></script>  

<script src="/js/vendor/highlight.min.js"></script>  
<script>hljs.initHighlightingOnLoad();</script>
                                                       


</body>
</html>
