<!doctype html>
<html class="no-js" lang="">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, maximum-scale=1">
    <title>Using KeePassXC as your system-keyring and ssh-agent - Cogitri&#39;s blog</title>

    
    <meta name="keywords" content="">
    <meta name="description" content="">
    
    <link rel="stylesheet" href="/css/highlight.min.css">
    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="/css/diello.css">
    <link rel="stylesheet" href="/css/main.css">
    
    
</head>


<body>
    <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
    <![endif]-->

  
    <div class="flex-column">
        <div class="ads">
    
</div>

        <div class="home">
            <div class="logo">
                <h1><a href="/">Cogitri&#39;s blog</a></h1>
            </div>
            <div class="navigation">
    
    <a href="/" class="">HOME</a>
    <a href="javascript:void(0);" class="current">ARTICLE</a>
    
</div>

            <div>
                <article>
                    <h3>Using KeePassXC as your system-keyring and ssh-agent</h3>
                    <div class="less">
                        <time>Published: Monday, Nov 4, 2019</time>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;4 minute read&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;Using 752 words
                    </div>
                    <div class="em">

<h1 id="introduction">Introduction</h1>

<blockquote>
<p>Guest article by maxice8</p>
</blockquote>

<p>Recently the community-oriented password manager <a href="https://keepassxc.org/">KeePassXC</a> made a new
major release, 2.5.0.</p>

<p>In this new release there was a really important change, the implementation of the
<a href="https://freedesktop.org/wiki/Specifications/secret-storage-spec/secrets-api-0.1.html">secrets API</a>
from Freedesktop.</p>

<blockquote>
<p>This is oversimplified</p>
</blockquote>

<p>For those that don&rsquo;t know, the secrets API is a specification for
storing and querying secrets (duh) like passwords, tokens and ssh keys, and really
anything you wanted.</p>

<p>After getting pleasantly surprised that someone else updated the keepassxc package on
Alpine Linux, I decided to enable keepassxc as my system-keyring instead of gnome-keyring</p>

<h1 id="setting-up-within-keepassxc">Setting up within keepassxc</h1>

<p>First thing to do is enabling the <code>Secret Service Integration</code> on keepassxc itself, this can
be done by clicking on <code>Tools</code> in the bar on top, then <code>Settings</code> and scrolling down the left bar
and clicking on <code>Secret Service Integration</code>. Then tick
<code>Enable KeepassXC Freedesktop.org Secret Service Integration</code>.</p>

<p>After enabling the <code>Secret Service Integration</code>, you need to change the database settings so
the entries of the database are exposed via the integration.</p>

<p>First click on <code>Database</code> on the bar on top then on <code>Database Settings ...</code> and then click on
<code>Secret Service Integration</code> and tick the option <code>Expose entries under this group:</code>, below the
option there is a tree manager so you can pick only a part of the entries of the database to
be exposed.</p>

<p>To make sure it works, have your database unlocked (should already be for changing the setting
above) and use <code>secret-tool(1)</code> to query for a secret on your database.</p>

<blockquote>
<p>The key called &lsquo;secret&rsquo; is [REDACTED] for obvious reasons</p>
</blockquote>

<pre><code class="language-ini">$ secret-tool search --unlock Path lichess
[/org/freedesktop/secrets/collection/all/8cbc4c2af67a428a8b7859fdaf25881b]
label = lichess
secret = [REDACTED]
created = 2019-09-06 17:31:10
modified = 2019-10-30 01:18:16
attribute.Title = lichess
attribute.URL = https://lichess.org
attribute.UserName = voidlinux1
attribute.Path = /lichess
attribute.Uuid = 8cbc4c2af67a428a8b7859fdaf25881b
attribute.Notes = 
</code></pre>

<blockquote>
<p>PS: hit me up on lichess.org if you want to play :D</p>
</blockquote>

<h1 id="experience-thus-far">Experience thus far</h1>

<p>Replacing my previous system-keyring provider, gnome-keyring, proved to be
overall good but with some very annoying quirks.</p>

<p>Benefits:</p>

<ul>
<li>I don&rsquo;t need more shell code to properly initialize gnome-keyring</li>
<li>I don&rsquo;t need to wrestle around with PAM to properly initialize and unlock the keyring</li>
<li>The place where I store my secrets in my computer and everywhere else is the same</li>
</ul>

<p>Drawbacks:</p>

<ul>
<li>I can&rsquo;t use my system-keyring to automatically unlock the database on login and unlock</li>
<li>There is no pop-up dialog like in gnome-keyring to unlock the database when something queries
for secrets using the freedesktop API</li>
</ul>

<h1 id="integrating-with-ssh-agent">Integrating with ssh-agent</h1>

<p>Speaking of which, since gnome-keyring was gone i needed to re-enable <code>ssh-agent(1)</code> so
i can use my precious precious (that i dispose and replace a lot) ssh keys everywhere.</p>

<p>I start <code>ssh-agent(1)</code> on my .profile, which is run every time I login with the following
code:</p>

<pre><code class="language-sh">if ! pgrep -x ssh-agent -u $(id -u) &gt;/dev/null; then
	# This sets SSH_AUTH_SOCK and SSH_AGENT_PID variables
	eval &quot;$(ssh-agent -s)&quot;
	export SSH_AUTH_SOCK SSH_AGENT_PID
	cat &gt; &quot;$XDG_RUNTIME_DIR/ssh-agent-env&quot; &lt;&lt;- __EOF__
	export SSH_AUTH_SOCK=$SSH_AUTH_SOCK
	export SSH_AGENT_PID=$SSH_AGENT_PID
	__EOF__
else
	if [ -s &quot;$XDG_RUNTIME_DIR/ssh-agent-env&quot; ]; then
		. $XDG_RUNTIME_DIR/ssh-agent-env
	fi
fi
</code></pre>

<p>It checks if there is an <code>ssh-agent(1)</code> running under my user, If not then it starts
it and exports <code>SSH_AUTH_SOCK</code> which is the path of the socket you can use
to communicate with <code>ssh-agent(1)</code>.</p>

<p>It also writes a file called <code>ssh-agent-env</code> to my <code>XDG_RUNTIME_DIR</code> which is sourced
by any shell that reads .profile (all of the shells started in the console)
so all my sessions can use the same ssh-agent.</p>

<p><code>SSH_AUTH_SOCK</code> is used by keepassxc for ssh-agent integration, having the
variable being set in .profile guarantees that it will be available for keepassxc
to use, since .profile also starts X and keepassxc is started within X.</p>

<p>To enable ssh-agent integration on keepassxc just click on <code>Tools</code> in the top bar
then click on <code>Settings</code> and then on the left-side click on <code>SSH Agent</code> and tick
the box <code>Enable SSH Agent (requires restart)</code> and restart (as told 4 to 5 words ago)
keepassxc.</p>

<h1 id="adding-an-ssh-key">Adding an SSH key</h1>

<p>Adding a ssh-key is very simple, just create a new entry which has its password field
be the password for the key being used, then click on <code>Advanced</code> and add the private key
as an attachment.</p>

<p>After adding the SSH key as an attachment, click on <code>SSH Agent</code> on the left side and tick
<code>Add key to agent when database is opened/unlocked</code> and select the attachment you just
added on the private key section.</p>

<p>You can then copy the public key part to your clipboard and use it wherever you have to
use, like GitHub, GitLab, etc.</p>
</div>
                    <br />
                    <br />
                    <div class="less">Page link: <a href="/post/03-keepassxc-freedesktop-secret/" class="pagelink">/post/03-keepassxc-freedesktop-secret/</a></div>
                    <div class="line-dotted"></div>
                <article>
            </div>
            <footer>
    <div>
    
          	 
    
    </div>
</footer>

        </div>
        <div class="ads">
    
</div>

    </div>


  <script src="/js/vendor/modernizr-3.6.0.min.js"></script>
<script src="/js/vendor/jquery-3.3.1.min.js"></script>
<script>window.jQuery || document.write('<script src="\/js/vendor/jquery-3.3.1.min.js"><\/script>')</script>
<script src="/js/plugins.js"></script>
<script src="/js/main.js"></script>  

<script src="/js/vendor/highlight.min.js"></script>  
<script>hljs.initHighlightingOnLoad();</script>
                                                       


</body>
</html>
