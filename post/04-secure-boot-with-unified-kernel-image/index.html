<!DOCTYPE html>
<html lang="en-gb">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://www.cogitri.dev/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://www.cogitri.dev/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://www.cogitri.dev/css/github.min.css' />
    <link rel="stylesheet" href='https://www.cogitri.dev/css/github-style.css' />
    <link rel="stylesheet" href='https://www.cogitri.dev/css/light.css' />
    <link rel="stylesheet" href='https://www.cogitri.dev/css/dark.css' />
    <link rel="stylesheet" href='https://www.cogitri.dev/css/syntax.css' />
    <title>Booting Alpine Linux with a Unified Kernel Image and Secure Boot - Cogitri&#39;s blog</title>
    
    <link rel="icon" type="image/x-icon" href='https://www.cogitri.dev/images/favicon.ico'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="Guest article by maxice8 Recently I got myself into package sd-boot from the Systemd project into Alpine Linux. I previously packaged it as an April&amp;rsquo;s fools joke for Void Linux Here.
" />
<meta name="keywords"
  content='' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://www.cogitri.dev/post/04-secure-boot-with-unified-kernel-image/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Booting Alpine Linux with a Unified Kernel Image and Secure Boot - Cogitri&#39;s blog" />
<meta name="twitter:description"
  content="Guest article by maxice8 Recently I got myself into package sd-boot from the Systemd project into Alpine Linux. I previously packaged it as an April&amp;rsquo;s fools joke for Void Linux Here.
" />
<meta name="twitter:site" content="https://www.cogitri.dev" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://www.cogitri.dev">


<meta property="og:type" content="article" />
<meta property="og:title" content="Booting Alpine Linux with a Unified Kernel Image and Secure Boot - Cogitri&#39;s blog">
<meta property="og:description"
  content="Guest article by maxice8 Recently I got myself into package sd-boot from the Systemd project into Alpine Linux. I previously packaged it as an April&amp;rsquo;s fools joke for Void Linux Here.
" />
<meta property="og:url" content="https://www.cogitri.dev/post/04-secure-boot-with-unified-kernel-image/" />
<meta property="og:site_name" content="Booting Alpine Linux with a Unified Kernel Image and Secure Boot" />
<meta property="og:image"
  content="https://www.cogitri.dev">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2020-02-02 06:07:10 &#43;0100 CET" />










</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://www.cogitri.dev">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd"
            d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://www.cogitri.dev">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://www.cogitri.dev">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
          width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://www.cogitri.dev">
                  <img class=" avatar-user"
                    src="https://avatars1.githubusercontent.com/u/8766773?s=460&amp;v=4"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://www.cogitri.dev">Rasmus Thomsen</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://www.cogitri.dev/post/04-secure-boot-with-unified-kernel-image/">Booting Alpine Linux with a Unified Kernel Image and Secure Boot</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Sun, 02 Feb 2020 06:07:10 &#43;0100"
                    class="no-wrap">
                    Sun, 02 Feb 2020 06:07:10 &#43;0100</relative-time>

                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      1525 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><h6 id="guest-article-by-maxice8">Guest article by maxice8</h6>
<p>Recently I got myself into package <code>sd-boot</code> from the Systemd project
into Alpine Linux. I previously packaged it as an April&rsquo;s fools joke
for Void Linux <a href="https://github.com/void-linux/void-packages/pull/10469/">Here</a>.</p>
<p>After receiving some negative feedback on including it, more specifically
about the fact I had to include 23 patches (which could be trimmed but would
be more work than just copying the work of the
<a href="http://www.openembedded.org/wiki/Main_Page">OpenEmbedded</a> and
<a href="https://github.com/NixOS/rfcs/blob/master/rfcs/0023-musl-libc.md">NixOS Musl</a>
people) to make it compile.</p>
<p>A side-effect of packaging <code>sd-boot</code> is that I got into, and learnt a
few things about booting directly from UEFI. Including:</p>
<ul>
<li>Creating Unified Kernel Images as described
<a href="https://systemd.io/BOOT_LOADER_SPECIFICATION/">here</a>.</li>
<li>Creating all the components necessary for Secure Boot.</li>
<li>Signing the Unified Kernel Image to boot under Secure Boot.</li>
</ul>
<h1 id="unified-kernel-images">Unified Kernel Images</h1>
<p>Unified Kernel Images, according to the documentation is:</p>
<blockquote>
<p>A unified kernel image is a single EFI PE executable combining an
EFI stub loader, a kernel image, an initramfs image, and the kernel command line.</p>
</blockquote>
<p>So basically a big file with all the components necessary for booting
directly from UEFI instead of relying on a bootloader. Easier for
signing.</p>
<h2 id="installing">Installing</h2>
<p>The first step is installing the packages necessary to perform all the
steps necessary to have a working Unified Kernel Image.</p>
<p>For this we are using <a href="https://alpinelinux.org/">Alpine Linux</a> since
it&rsquo;s what I use (Change the commands to equivalents of your distribution).</p>
<p>We need to install the <code>binutils</code> package which provides the <code>objcopy</code>
binary and <code>gummiboot</code> which provides the EFI stub loader in
<code>/usr/lib/gummiboot/linuxx64.efi.stub</code>.</p>
<p>Both are in the main repository, so installing them is a matter of just
calling <code>apk</code> with the proper commands:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># apk add binutils gummiboot</span>
</span></span></code></pre></div><h2 id="unifying">Unifying</h2>
<p>With all the packages installed we can make the Unified Kernel Image.</p>
<h3 id="cpu-microcode">CPU Microcode</h3>
<p>One of the components of the Unified Kernel Image is the initramfs. On
other bootloaders you can just specify more than initramfs, having the
CPU microcode coming before the actual initramfs.</p>
<p>Not so much with the Unified Kernel Image. For that we will have to
create a single initramfs that includes the CPU microcode.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cat /boot/intel-ucode.img /boot/initramfs-lts &gt; /tmp/initramfs-lts
</span></span></code></pre></div><p>Simply enough, that will work. Remember to change the intel-ucode for
whatever AMD uses or to ignore this section altogether if you don&rsquo;t
need it.</p>
<h3 id="objcopying">objcopying</h3>
<p>Now that we have our initramfs with the microcode we can use <code>objcopy</code>
to create the image. We will have 4 sections:</p>
<ul>
<li>.osrel, where the contents of <code>/etc/os-release</code> are present (some
distributions have it in <code>/usr/lib/os-release</code>, but not Alpine Linux)</li>
<li>.cmdline, where the options passed to the command line of the kernel
are present, we will use <code>/proc/cmdline</code> to get from our currently
running kernel, but you can write your own into a file and use it
instead.</li>
<li>.linux, the kernel itself goes here.</li>
<li>.initrd, the initramfs itself goes here.</li>
</ul>
<p>We will use the EFI stub loader from <code>gummiboot</code> which is present in
<code>/usr/lib/gummiboot/linuxx64.efi.stub</code> and the Unified Kernel Image
will be written to <code>/boot</code> as <code>alpine.efi</code>.</p>
<p>The <code>objcopy</code> invocation goes like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>objcopy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--add-section .osrel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/etc/os-release&#34;</span> --change-section-vma .osrel<span style="color:#f92672">=</span>0x20000 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--add-section .cmdline<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/proc/cmdline&#34;</span> --change-section-vma .cmdline<span style="color:#f92672">=</span>0x30000 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--add-section .linux<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/boot/linux-lts&#34;</span> --change-section-vma .linux<span style="color:#f92672">=</span>0x40000 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--add-section .initrd<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/tmp/unified-initramfs&#34;</span> --change-section-vma .initrd<span style="color:#f92672">=</span>0x3000000 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	/usr/lib/gummiboot/linuxx64.efi.stub /boot/alpine.efi
</span></span></code></pre></div><p>And we have a functional Unified Kernel Image.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ file /boot/alpine.efi
</span></span><span style="display:flex;"><span>/boot/alpine.efi: PE32+ executable <span style="color:#f92672">(</span>EFI application<span style="color:#f92672">)</span> x86-64 <span style="color:#f92672">(</span>stripped to external PDB<span style="color:#f92672">)</span>, <span style="color:#66d9ef">for</span> MS Windows
</span></span></code></pre></div><h1 id="secure-boot">Secure Boot</h1>
<p>One of the things I wanted to do when re-creating my boot scheme by
using <code>sd-boot</code> was to have Secure Boot enabled. Just for challenging
myself into new territory.</p>
<p><a href="https://wiki.archlinux.org/index.php/Secure_Boot">Arch Linux Wiki</a> has
a full page on it, and they point to an extensive article on Secure
Boot. I won&rsquo;t waste anytime trying to explain Secure Boot, the article
referred from the Arch Linux Wiki is written by someone that is much more
qualified to write about it than me. (That is your call to give it a read
if you are interested, I&rsquo;ll wait)</p>
<p>In my approach I made my own keys, which seemed easier than using Shim or
PreLoader.</p>
<h2 id="installing-1">Installing</h2>
<p>First we install the components necessary, we will need <code>efitools</code>. It is
available only in <code>edge</code> because it was in the <code>testing</code> repository.
I have moved it to main so it should make it to 3.12 but not 3.11 and
below. So enable the testing repository and install it.</p>
<p>We will also use the <code>sbsign</code> binary from the <code>sbsigntool</code> package.
It has the same situation as <code>efitools</code>, was in testing, moved to
main, should be available in Alpine Linux 3.12 but not 3.11 and below.</p>
<p>In the meantime we will also use <code>uuidgen</code> from the <code>util-linux</code>
package, so if you didn&rsquo;t have that package installed already, do it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># apk add efitools sbsigntool util-linux</span>
</span></span></code></pre></div><p>You will also need the <code>openssl</code> command from the <code>openssl</code> package (
or <code>libressl</code> if your Alpine Linux version uses that). But since that
is a system package that is very widely used, I will assume you already
have it.</p>
<p>The following are literally copied from the Arch Linux Wiki.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ uuidgen --random &gt; GUID.txt
</span></span><span style="display:flex;"><span>$ openssl req -newkey rsa:4096 -nodes -keyout PK.key -new -x509 -sha256 -days <span style="color:#ae81ff">3650</span> -subj <span style="color:#e6db74">&#34;/CN=my Platform Key/&#34;</span> -out PK.crt
</span></span><span style="display:flex;"><span>$ openssl x509 -outform DER -in PK.crt -out PK.cer
</span></span><span style="display:flex;"><span>$ cert-to-efi-sig-list -g <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>&lt; GUID.txt<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> PK.crt PK.esl
</span></span><span style="display:flex;"><span>$ sign-efi-sig-list -g <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>&lt; GUID.txt<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -k PK.key -c PK.crt PK PK.esl PK.auth
</span></span><span style="display:flex;"><span>$ sign-efi-sig-list -g <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>&lt; GUID.txt<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -c PK.crt -k PK.key PK /dev/null rm_PK.auth
</span></span><span style="display:flex;"><span>$ openssl req -newkey rsa:4096 -nodes -keyout KEK.key -new -x509 -sha256 -days <span style="color:#ae81ff">3650</span> -subj <span style="color:#e6db74">&#34;/CN=my Key Exchange Key/&#34;</span> -out KEK.crt
</span></span><span style="display:flex;"><span>$ openssl x509 -outform DER -in KEK.crt -out KEK.cer
</span></span><span style="display:flex;"><span>$ cert-to-efi-sig-list -g <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>&lt; GUID.txt<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> KEK.crt KEK.esl
</span></span><span style="display:flex;"><span>$ sign-efi-sig-list -g <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>&lt; GUID.txt<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -k PK.key -c PK.crt KEK KEK.esl KEK.auth
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ openssl req -newkey rsa:4096 -nodes -keyout db.key -new -x509 -sha256 -days <span style="color:#ae81ff">3650</span> -subj <span style="color:#e6db74">&#34;/CN=my Signature Database key/&#34;</span> -out db.crt
</span></span><span style="display:flex;"><span>$ openssl x509 -outform DER -in db.crt -out db.cer
</span></span><span style="display:flex;"><span>$ cert-to-efi-sig-list -g <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>&lt; GUID.txt<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> db.crt db.esl
</span></span><span style="display:flex;"><span>$ sign-efi-sig-list -g <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>&lt; GUID.txt<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -k KEK.key -c KEK.crt db db.esl db.auth
</span></span></code></pre></div><h2 id="enrolling">Enrolling</h2>
<p>Now that the keys were made we need to add them to the Motherboard. As
of writing this I&rsquo;m using a Dell Inspiron 5566. The Dell firmware is really
really nice and allows me to do all the required operations by just clicking
around their interface.</p>
<p>That means you will have to figure your way in your motherboard&rsquo;s firmware.</p>
<p>First copy the required files to the FAT boot partition that the motherboard
can see.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># cp *.cer *.esl *.auth /boot</span>
</span></span></code></pre></div><p>Then reboot into your motherboard&rsquo;s firmware and enroll them. You can remove
the files afterward.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># rm -f /boot/*.cer /boot/*.esl /boot/*.auth</span>
</span></span></code></pre></div><h2 id="signing">Signing</h2>
<p>Now that our keys are enrolled we can sign our Unified Kernel Image:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sbsign --key db.key --cert db.crt --output /boot/alpine.efi /boot/alpine.efi
</span></span></code></pre></div><h1 id="booting">Booting</h1>
<p>The last step is creating an UEFI boot entry, stored normally in NVRAM
as UEFI config variables with boot configuration along them.</p>
<h2 id="installing-2">Installing</h2>
<p>To deal with UEFI config variables in Linux we need the <code>mount</code>
command which is part of the <code>busybox</code> package, it will be
replaced with the <code>mount</code> command from the <code>util-linux</code> package
if the latter is installed, but both are OK.</p>
<p>To manipulate the UEFI config variables we will use the
<code>efibootmgr</code> command from the <code>efibootmgr</code> package. It is in
the community repository.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># apk add efibootmgr</span>
</span></span></code></pre></div><h2 id="mounting">Mounting</h2>
<p>First we need to mount the UEFI config variables with the efivarfs
filesystem. According to the
<a href="https://www.kernel.org/doc/Documentation/filesystems/efivarfs.txt">kernel documentation</a>
it can be done like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># mount -t efivarfs none /sys/firmware/efi/efivars</span>
</span></span></code></pre></div><h2 id="configuring">Configuring</h2>
<p>Now we create the boot entry with <code>efibootmgr</code>. I&rsquo;ll show the final
invocation of <code>efibootmgr</code> first and explain each switch/flag used
separately below it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># efibootmgr \</span>
</span></span><span style="display:flex;"><span>	--create <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--disk /dev/sda <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--part <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--label <span style="color:#e6db74">&#34;Alpine Linux&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	--loader <span style="color:#e6db74">&#34;\alpine.efi&#34;</span>
</span></span></code></pre></div><p>So:</p>
<ul>
<li>The <code>--create</code> call should be obvious, we want to create the boot
entry, with it we also add it to the boot order, if you do not wish
to add to it to the boot order then <code>--create-only</code> can be used.</li>
<li><code>--disk /dev/sda</code> points to the disk where the EFI partition is, if
your EFI partition is in another disk then change it appropriately.</li>
<li><code>--part 1</code> is the number of the partition, since my EFI partition is
in /dev/sda1 then this is 1, but if your partition is in /dev/sda5 then
it is 5.</li>
<li><code>--label &quot;Alpine Linux&quot;</code> label used, this will appear in the Motherboard
Firmware for editing and when you press F12 (or whatever F-Key) to pick
a different boot option. If you use another distribution then change it
to it.</li>
<li><code>--loader &quot;\alpine.efi&quot;</code> the location of the Unified Kernel Image, in
relation to the EFI partition, since we used /boot/alpine.efi then we
set it to \alpine.efi (NOTE: the backslash is how it should be, this is
Windows stuff).</li>
</ul>
<p>After calling the invocation you can use <code>efibootmgr</code> to see if was added
properly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ efibootmgr
</span></span><span style="display:flex;"><span>BootCurrent: <span style="color:#ae81ff">0000</span>
</span></span><span style="display:flex;"><span>Timeout: <span style="color:#ae81ff">0</span> seconds
</span></span><span style="display:flex;"><span>BootOrder: <span style="color:#ae81ff">0000</span>
</span></span><span style="display:flex;"><span>Boot0000* Alpine Linux
</span></span></code></pre></div><p>This is my system, I have executed the order 66 on all other boot options,
your should still have the other options like &ldquo;Windows Boot Manager&rdquo;. The
important thing here is that the &ldquo;Alpine Linux&rdquo; entry appears.</p>
<p>If you wish to have it default to booting Alpine Linux then have it be
the first boot entry that appears in BootOrder.</p></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://www.cogitri.dev/js/toc.js'></script>
<link rel="stylesheet" href='https://www.cogitri.dev/css/toc.css' />


  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://www.cogitri.dev">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://www.cogitri.dev/js/github-style.js"></script>




</html>