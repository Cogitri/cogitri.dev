<!doctype html>
<html class="no-js" lang="">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, maximum-scale=1">
    <title>Booting Alpine Linux with a Unified Kernel Image and Secure Boot - Cogitri&#39;s blog</title>

    
    <meta name="keywords" content="">
    <meta name="description" content="">
    
    <link rel="stylesheet" href="/css/highlight.min.css">
    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="/css/diello.css">
    <link rel="stylesheet" href="/css/main.css">
    
    
</head>


<body>
    <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
    <![endif]-->

  
    <div class="flex-column">
        <div class="ads">
    
</div>

        <div class="home">
            <div class="logo">
                <h1><a href="/">Cogitri&#39;s blog</a></h1>
            </div>
            <div class="navigation">
    
    <a href="/" class="">HOME</a>
    <a href="javascript:void(0);" class="current">ARTICLE</a>
    
</div>

            <div>
                <article>
                    <h3>Booting Alpine Linux with a Unified Kernel Image and Secure Boot</h3>
                    <div class="less">
                        <time>Published: Sunday, Feb 2, 2020</time>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;8 minute read&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;Using 1526 words
                    </div>
                    <div class="em"><h1 id="introduction">Introduction</h1>
<blockquote>
<p>Guest article by maxice8</p>
</blockquote>
<p>Recently I got myself into package <code>sd-boot</code> from the Systemd project
into Alpine Linux. I previously packaged it as an April&rsquo;s fools joke
for Void Linux <a href="https://github.com/void-linux/void-packages/pull/10469/">Here</a>.</p>
<p>After receiving some negative feedback on including it, more specifically
about the fact I had to include 23 patches (which could be trimmed but would
be more work than just copying the work of the
<a href="http://www.openembedded.org/wiki/Main_Page">OpenEmbedded</a> and
<a href="https://github.com/NixOS/rfcs/blob/master/rfcs/0023-musl-libc.md">NixOS Musl</a>
people) to make it compile.</p>
<p>A side-effect of packaging <code>sd-boot</code> is that I got into, and learnt a
few things about booting directly from UEFI. Including:</p>
<ul>
<li>Creating Unified Kernel Images as described
<a href="https://systemd.io/BOOT_LOADER_SPECIFICATION/">here</a>.</li>
<li>Creating all the components necessary for Secure Boot.</li>
<li>Signing the Unified Kernel Image to boot under Secure Boot.</li>
</ul>
<h1 id="unified-kernel-images">Unified Kernel Images</h1>
<p>Unified Kernel Images, according to the documentation is:</p>
<blockquote>
<p>A unified kernel image is a single EFI PE executable combining an
EFI stub loader, a kernel image, an initramfs image, and the kernel command line.</p>
</blockquote>
<p>So basically a big file with all the components necessary for booting
directly from UEFI instead of relying on a bootloader. Easier for
signing.</p>
<h2 id="installing">Installing</h2>
<p>The first step is installing the packages necessary to perform all the
steps necessary to have a working Unified Kernel Image.</p>
<p>For this we are using <a href="https://alpinelinux.org/">Alpine Linux</a> since
it&rsquo;s what I use (Change the commands to equivalents of your distribution).</p>
<p>We need to install the <code>binutils</code> package which provides the <code>objcopy</code>
binary and <code>gummiboot</code> which provides the EFI stub loader in
<code>/usr/lib/gummiboot/linuxx64.efi.stub</code>.</p>
<p>Both are in the main repository, so installing them is a matter of just
calling <code>apk</code> with the proper commands:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># apk add binutils gummiboot</span>
</code></pre></div><h2 id="unifying">Unifying</h2>
<p>With all the packages installed we can make the Unified Kernel Image.</p>
<h3 id="cpu-microcode">CPU Microcode</h3>
<p>One of the components of the Unified Kernel Image is the initramfs. On
other bootloaders you can just specify more than initramfs, having the
CPU microcode coming before the actual initramfs.</p>
<p>Not so much with the Unified Kernel Image. For that we will have to
create a single initramfs that includes the CPU microcode.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ cat /boot/intel-ucode.img /boot/initramfs-lts &gt; /tmp/initramfs-lts
</code></pre></div><p>Simply enough, that will work. Remember to change the intel-ucode for
whatever AMD uses or to ignore this section altogether if you don&rsquo;t
need it.</p>
<h3 id="objcopying">objcopying</h3>
<p>Now that we have our initramfs with the microcode we can use <code>objcopy</code>
to create the image. We will have 4 sections:</p>
<ul>
<li>.osrel, where the contents of <code>/etc/os-release</code> are present (some
distributions have it in <code>/usr/lib/os-release</code>, but not Alpine Linux)</li>
<li>.cmdline, where the options passed to the command line of the kernel
are present, we will use <code>/proc/cmdline</code> to get from our currently
running kernel, but you can write your own into a file and use it
instead.</li>
<li>.linux, the kernel itself goes here.</li>
<li>.initrd, the initramfs itself goes here.</li>
</ul>
<p>We will use the EFI stub loader from <code>gummiboot</code> which is present in
<code>/usr/lib/gummiboot/linuxx64.efi.stub</code> and the Unified Kernel Image
will be written to <code>/boot</code> as <code>alpine.efi</code>.</p>
<p>The <code>objcopy</code> invocation goes like so:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">objcopy <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--add-section .osrel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/etc/os-release&#34;</span> --change-section-vma .osrel<span style="color:#f92672">=</span>0x20000 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--add-section .cmdline<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/proc/cmdline&#34;</span> --change-section-vma .cmdline<span style="color:#f92672">=</span>0x30000 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--add-section .linux<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/boot/linux-lts&#34;</span> --change-section-vma .linux<span style="color:#f92672">=</span>0x40000 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--add-section .initrd<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/tmp/unified-initramfs&#34;</span> --change-section-vma .initrd<span style="color:#f92672">=</span>0x3000000 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	/usr/lib/gummiboot/linuxx64.efi.stub /boot/alpine.efi
</code></pre></div><p>And we have a functional Unified Kernel Image.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ file /boot/alpine.efi
/boot/alpine.efi: PE32+ executable <span style="color:#f92672">(</span>EFI application<span style="color:#f92672">)</span> x86-64 <span style="color:#f92672">(</span>stripped to external PDB<span style="color:#f92672">)</span>, <span style="color:#66d9ef">for</span> MS Windows
</code></pre></div><h1 id="secure-boot">Secure Boot</h1>
<p>One of the things I wanted to do when re-creating my boot scheme by
using <code>sd-boot</code> was to have Secure Boot enabled. Just for challenging
myself into new territory.</p>
<p><a href="https://wiki.archlinux.org/index.php/Secure_Boot">Arch Linux Wiki</a> has
a full page on it, and they point to an extensive article on Secure
Boot. I won&rsquo;t waste anytime trying to explain Secure Boot, the article
referred from the Arch Linux Wiki is written by someone that is much more
qualified to write about it than me. (That is your call to give it a read
if you are interested, I&rsquo;ll wait)</p>
<p>In my approach I made my own keys, which seemed easier than using Shim or
PreLoader.</p>
<h2 id="installing-1">Installing</h2>
<p>First we install the components necessary, we will need <code>efitools</code>. It is
available only in <code>edge</code> because it was in the <code>testing</code> repository.
I have moved it to main so it should make it to 3.12 but not 3.11 and
below. So enable the testing repository and install it.</p>
<p>We will also use the <code>sbsign</code> binary from the <code>sbsigntool</code> package.
It has the same situation as <code>efitools</code>, was in testing, moved to
main, should be available in Alpine Linux 3.12 but not 3.11 and below.</p>
<p>In the meantime we will also use <code>uuidgen</code> from the <code>util-linux</code>
package, so if you didn&rsquo;t have that package installed already, do it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># apk add efitools sbsigntool util-linux</span>
</code></pre></div><p>You will also need the <code>openssl</code> command from the <code>openssl</code> package (
or <code>libressl</code> if your Alpine Linux version uses that). But since that
is a system package that is very widely used, I will assume you already
have it.</p>
<p>The following are literally copied from the Arch Linux Wiki.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ uuidgen --random &gt; GUID.txt
$ openssl req -newkey rsa:4096 -nodes -keyout PK.key -new -x509 -sha256 -days <span style="color:#ae81ff">3650</span> -subj <span style="color:#e6db74">&#34;/CN=my Platform Key/&#34;</span> -out PK.crt
$ openssl x509 -outform DER -in PK.crt -out PK.cer
$ cert-to-efi-sig-list -g <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>&lt; GUID.txt<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> PK.crt PK.esl
$ sign-efi-sig-list -g <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>&lt; GUID.txt<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -k PK.key -c PK.crt PK PK.esl PK.auth
$ sign-efi-sig-list -g <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>&lt; GUID.txt<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -c PK.crt -k PK.key PK /dev/null rm_PK.auth
$ openssl req -newkey rsa:4096 -nodes -keyout KEK.key -new -x509 -sha256 -days <span style="color:#ae81ff">3650</span> -subj <span style="color:#e6db74">&#34;/CN=my Key Exchange Key/&#34;</span> -out KEK.crt
$ openssl x509 -outform DER -in KEK.crt -out KEK.cer
$ cert-to-efi-sig-list -g <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>&lt; GUID.txt<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> KEK.crt KEK.esl
$ sign-efi-sig-list -g <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>&lt; GUID.txt<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -k PK.key -c PK.crt KEK KEK.esl KEK.auth

$ openssl req -newkey rsa:4096 -nodes -keyout db.key -new -x509 -sha256 -days <span style="color:#ae81ff">3650</span> -subj <span style="color:#e6db74">&#34;/CN=my Signature Database key/&#34;</span> -out db.crt
$ openssl x509 -outform DER -in db.crt -out db.cer
$ cert-to-efi-sig-list -g <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>&lt; GUID.txt<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> db.crt db.esl
$ sign-efi-sig-list -g <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>&lt; GUID.txt<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -k KEK.key -c KEK.crt db db.esl db.auth
</code></pre></div><h2 id="enrolling">Enrolling</h2>
<p>Now that the keys were made we need to add them to the Motherboard. As
of writing this I&rsquo;m using a Dell Inspiron 5566. The Dell firmware is really
really nice and allows me to do all the required operations by just clicking
around their interface.</p>
<p>That means you will have to figure your way in your motherboard&rsquo;s firmware.</p>
<p>First copy the required files to the FAT boot partition that the motherboard
can see.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># cp *.cer *.esl *.auth /boot</span>
</code></pre></div><p>Then reboot into your motherboard&rsquo;s firmware and enroll them. You can remove
the files afterward.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># rm -f /boot/*.cer /boot/*.esl /boot/*.auth</span>
</code></pre></div><h2 id="signing">Signing</h2>
<p>Now that our keys are enrolled we can sign our Unified Kernel Image:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ sbsign --key db.key --cert db.crt --output /boot/alpine.efi /boot/alpine.efi
</code></pre></div><h1 id="booting">Booting</h1>
<p>The last step is creating an UEFI boot entry, stored normally in NVRAM
as UEFI config variables with boot configuration along them.</p>
<h2 id="installing-2">Installing</h2>
<p>To deal with UEFI config variables in Linux we need the <code>mount</code>
command which is part of the <code>busybox</code> package, it will be
replaced with the <code>mount</code> command from the <code>util-linux</code> package
if the latter is installed, but both are OK.</p>
<p>To manipulate the UEFI config variables we will use the
<code>efibootmgr</code> command from the <code>efibootmgr</code> package. It is in
the community repository.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># apk add efibootmgr</span>
</code></pre></div><h2 id="mounting">Mounting</h2>
<p>First we need to mount the UEFI config variables with the efivarfs
filesystem. According to the
<a href="https://www.kernel.org/doc/Documentation/filesystems/efivarfs.txt">kernel documentation</a>
it can be done like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># mount -t efivarfs none /sys/firmware/efi/efivars</span>
</code></pre></div><h2 id="configuring">Configuring</h2>
<p>Now we create the boot entry with <code>efibootmgr</code>. I&rsquo;ll show the final
invocation of <code>efibootmgr</code> first and explain each switch/flag used
separately below it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># efibootmgr \</span>
	--create <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--disk /dev/sda <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--part <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--label <span style="color:#e6db74">&#34;Alpine Linux&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	--loader <span style="color:#e6db74">&#34;\alpine.efi&#34;</span>
</code></pre></div><p>So:</p>
<ul>
<li>The <code>--create</code> call should be obvious, we want to create the boot
entry, with it we also add it to the boot order, if you do not wish
to add to it to the boot order then <code>--create-only</code> can be used.</li>
<li><code>--disk /dev/sda</code> points to the disk where the EFI partition is, if
your EFI partition is in another disk then change it appropriately.</li>
<li><code>--part 1</code> is the number of the partition, since my EFI partition is
in /dev/sda1 then this is 1, but if your partition is in /dev/sda5 then
it is 5.</li>
<li><code>--label &quot;Alpine Linux&quot;</code> label used, this will appear in the Motherboard
Firmware for editing and when you press F12 (or whatever F-Key) to pick
a different boot option. If you use another distribution then change it
to it.</li>
<li><code>--loader &quot;\alpine.efi&quot;</code> the location of the Unified Kernel Image, in
relation to the EFI partition, since we used /boot/alpine.efi then we
set it to \alpine.efi (NOTE: the backslash is how it should be, this is
Windows stuff).</li>
</ul>
<p>After calling the invocation you can use <code>efibootmgr</code> to see if was added
properly.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ efibootmgr
BootCurrent: <span style="color:#ae81ff">0000</span>
Timeout: <span style="color:#ae81ff">0</span> seconds
BootOrder: <span style="color:#ae81ff">0000</span>
Boot0000* Alpine Linux
</code></pre></div><p>This is my system, I have executed the order 66 on all other boot options,
your should still have the other options like &ldquo;Windows Boot Manager&rdquo;. The
important thing here is that the &ldquo;Alpine Linux&rdquo; entry appears.</p>
<p>If you wish to have it default to booting Alpine Linux then have it be
the first boot entry that appears in BootOrder.</p>
</div>
                    <br />
                    <br />
                    <div class="less">Page link: <a href="/post/04-secure-boot-with-unified-kernel-image/" class="pagelink">/post/04-secure-boot-with-unified-kernel-image/</a></div>
                    <div class="line-dotted"></div>
                <article>
            </div>
            <footer>
    <div>
    
          	 
    
    </div>
</footer>

        </div>
        <div class="ads">
    
</div>

    </div>


  <script src="/js/vendor/modernizr-3.6.0.min.js"></script>
<script src="/js/vendor/jquery-3.3.1.min.js"></script>
<script>window.jQuery || document.write('<script src="\/js/vendor/jquery-3.3.1.min.js"><\/script>')</script>
<script src="/js/plugins.js"></script>
<script src="/js/main.js"></script>  

<script src="/js/vendor/highlight.min.js"></script>  
<script>hljs.initHighlightingOnLoad();</script>
                                                       


</body>
</html>
